<?xml version="1.0"?>

<project basedir="." default="main">

  <property environment="ENV"/>
  <property name="forrest.home" location="${ENV.FORREST_HOME}"/>
  <property name="bot.home" location="${forrest.home}/forrestbot2/core"/>
  <import file="${forrest.home}/forrest.build.xml"/>

  <!--<import file="${bot.home}/rebuild-forrest.xml"/>-->
  <import file="${bot.home}/cvs.xml"/>
  <import file="${bot.home}/local.xml"/>
  <import file="${bot.home}/email.xml"/>

  <property name="administrator"  value="jefft@apache.org"/>
  <property name="build.work-dir"         location="work/${ant.project.name}"/>
  <property name="build.site-dir"         location="work/${ant.project.name}/site"/>
  <property name="build.deploy-dir"       location="sites/${ant.project.name}"/>
  
  <tstamp>
    <format property="logtime" pattern="yyMMdd-hhmm"/>
  </tstamp>

  <property name="build.log-dir" location="logs"/>
  <mkdir dir="${build.log-dir}"/>
  <property name="build.logfile" location="${build.log-dir}/${ant.project.name}.log"/>
  <property name="build.logfile-stored" location="${build.log-dir}/${ant.project.name}-${logtime}.log"/> 

  <property name="mail.host" value="localhost"/>
  <property name="mail.to"   value="${user.name}@localhost"/>

  <target name="getsrc" depends="cvs.getsrc"/>

  <target name="site" depends="getsrc">

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
      <classpath>
        <pathelement location="${forrest.home}/forrestbot/lib/ant-contrib-0.1.jar"/>
      </classpath>
    </taskdef>

    <trycatch property="errmsg">
      <try>
        <record name="${build.logfile}" action="start"/>
        <echo>
          ....... Forrest render START
          ... Rendering docs in ${build.work-dir}
        </echo>
        <antcall target="forrest.site" inheritAll="false">
          <param name="project.home" value="${build.work-dir}"/>
          <param name="project.build-dir" value="${build.work-dir}"/>
          <param name="project.site-dir" value="${build.site-dir}"/>
        </antcall>
        <echo>
          ....... Forrest render END
        </echo>
        <record name="${build.logfile}" action="stop"/>
        <property name="completion-status" value="succeeded" />
      </try>
      <catch>
        <record name="${build.logfile}" action="stop"/>
        <echo>Oops, something broke</echo>
        <property name="completion-status" value="FAILED" />
        <property name="build-failed" value="true"/>
        <throw refid="exception" message="${errmsg}"/>
      </catch>
    </trycatch>
    <copy file="${build.logfile}" tofile="${build.logfile-stored}"/>
  </target>

  <target name="deploy" depends="local.deploy"/>

  <target name="notify" depends="local.notify"/>

  <target name="main" depends="getsrc, site, deploy, notify"/>

</project>
