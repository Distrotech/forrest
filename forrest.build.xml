<?xml version="1.0"?>

<!--
Ant template-targets holding the actions forrest can peform on your project.
Eventually all of this should be wrapped up into a Java Class and/or ant task

This should be called by some forrest.bat or forrest.sh having a project-dir
as its argument (. if none)
That should be passed to here with -Dproject.home
-->


<project default="site" basedir="." name="Forrest template targets">

  <description>
    *=======================================================*
    |   Forrest ant based site building target-templates    | 
    *=======================================================*
                              by
                  Marc Portier (mpo@apache.org)
  
        Call this through the ./bin/forrest.sh or *.bat
  </description>
  
  

<!-- ***************************************************************** -->
<!-- ***************************************************************** -->
<!-- **                                                             ** -->
<!-- **                                                             ** -->
<!-- **                    COMMON SETTINGS                          ** -->
<!-- **                                                             ** -->
<!-- **                                                             ** -->
<!-- ***************************************************************** -->
<!-- ***************************************************************** -->

  <!-- ===============================================================
       Loads user defined settings.
       Steps back to defaults when they are not set.
       Echo's the settings if requested.
       =============================================================== -->
  <target name="init-props">
  
    <!-- setting defaults for parameters -->
    <!-- people should use -D switch, or <ant><property>s to override these   -->

    <property name="project.home" location="." />

    <echo message="Loading project specific properties from ${project.home}/forrest.properties" />
    <property file="${project.home}/forrest.properties" />

    <!-- people should use forrest.properties to override following defaults  -->
    <property name="forrest.home"        location="." />
    <property name="project.site-dir"    value="${project.home}/build/site"    />
    <property name="project.war"         value="${project.home}/build/my-project.war" />
    <property name="project.webapp"      value="${project.home}/build/webapp" />
    <property name="project.siteplan"    value="${project.home}/siteplan.xml"  />

    <property name="project.temp-dir"    value="${project.home}/build/tmp"     />
    <property name="project.work-dir"    value="${project.temp-dir}/work"      />
    <property name="project.ctxt-dir"    value="${project.temp-dir}/context"   />

    <property name="project.logfile"     value="${project.temp-dir}/forrest.log"/>
    <property name="project.brokenlinkfile" value="${project.temp-dir}/brokenlinks.txt"/>
    <property name="project.debuglevel"  value="ERROR"                         />
    <property name="project.start-uri"   value="index.html"                    />

    <!-- odd one in the list: forrest provides this, 
         project now has a means to override it? -->
    <property name="project.configfile"  value="${forrest.home}/WEB-INF/cocoon.xconf"/>

    <!-- use of these property should be removed when the siteplan becomes active -->
    <property name="project.skin"        value="forrest-site" />
    <property name="project.status"      value="${project.home}/status.xml" />
    <property name="project.content-dir" value="${project.home}/src/documentation" />
    <property name="project.sitemap"     value="${project.content-dir}/sitemap.xmap" />
    <property name="project.xdocs-dir"   value="${project.content-dir}/content/xdocs" />
    <property name="project.stylesheets-dir" value="${project.content-dir}/resources/stylesheets" />
    <property name="project.images-dir"  value="${project.content-dir}/resources/images" />
    <property name="project.schema-dir" value="${project.content-dir}/resources/schema" />
    <property name="project.skins-dir"   value="${project.content-dir}/skins" />
    <property name="project.skinconf"    value="${project.content-dir}/skinconf.xml" />
    <available property="project.skinconf.present" file="${project.skinconf}" type="file"/>
    <property name="project.lib-dir"     value="${project.content-dir}/lib" />
    <property name="project.classes-dir" value="${project.content-dir}/classes" />

    <!-- checks for presence of required classes and/or resources -->
    <property name="tools.jar"           location="${java.home}/../lib/tools.jar"/>
    <available file="${tools.jar}"       property="tools.jar.present"/>

    <!-- echo settings in -Dforrest.echo=true mode -->
    <antcall target="echo-settings" />

  </target>

  <!-- Load properties from user's skinconf.xml, if it is defined -->
  <target name="load-project-props" depends="init-props" if="project.skinconf.present">
    <xmlproperty file="${project.skinconf}" collapseattributes="true"
      validate="true"/>
  </target>

  <!-- Load properties from Forrest's default skinconf.xml, unless a user's is defined -->
  <target name="load-forrest-props" depends="init-props" unless="project.skinconf.present">
    <xmlproperty file="${forrest.home}/context/skinconf.xml"
      collapseattributes="true" validate="true"/>
  </target>

  <!-- Define filters equating to elements in the skinconf.xml file. Skins can
  include tokens corresponding to skinconf.xml elements, and have them replaced
  at runtime.-->
  <target name="init-skinprops" depends="load-project-props, load-forrest-props">
    <mkdir dir="${project.temp-dir}"/>
    <property name="skinfilters" value="${project.temp-dir}/skinfilters.properties"/>
    <echoproperties prefix="skinconfig" destfile="${skinfilters}"/>
    <filter filtersfile="${skinfilters}"/>
  </target>

  <target name="init" depends="init-props, init-skinprops" description="Sets up
    properties and filters"/>

  <!-- ===============================================================
       Echo's the settings if requested. [-Dforrest.echo=true]
       =============================================================== -->
  <target name="echo-settings" if="forrest.echo">
    <echo>
      ------------------------------------------------
      | Forrest template run.
      | Running from $${forrest.home} = ${forrest.home}
      | Working on   $${project.home} = ${project.home}
      ------------------------------------------------
      | //where to put the result
      | project.site-dir    = ${project.site-dir} 
      | //uri to start crawling/generation process
      | project.start-uri   = ${project.start-uri}
      | //masterplan for building site (dreamware)
      | project.siteplan    = ${project.siteplan} 
      | //cocoon.xconf location
      | project.configfile  = ${project.configfile}
      | //temp dir to throw stuf in (i.e. work and ctxt)
      | project.temp-dir    = ${project.temp-dir} 
      | //temp working directory for generation process
      | project.work-dir    = ${project.work-dir} 
      | //temp context directory for generation process
      | project.ctxt-dir    = ${project.ctxt-dir} 
      | //debuglevel for logging (INFO, DEBUG, WARN, ERROR, FAIL)
      | project.debuglevel  = ${project.debuglevel}
      | //logfile location
      | project.logfile     = ${project.logfile}
      | //list of broken links put in:
      | project.brokenlinkfile = ${project.brokenlinkfile}
      | //check if you have tools.jar installed.
      | tools.jar.present   = ${tools.jar.present} 
      ------------------------------------------------
      | Following could be removed from future builds
      | //which skin to apply
      | project.skin        = ${project.skin} 
      | //where your documentation xml is
      | project.content-dir = ${project.content-dir} 
      ------------------------------------------------
    </echo>
  </target>


  <!-- ===============================================================
       Set class-path.
       =============================================================== -->
  <target name="prepare-classpath" depends="prepare-context" >
    <path id="forrest.cp">
      <pathelement location="${project.ctxt-dir}/WEB-INF/classes"/>
      <fileset dir="${project.ctxt-dir}/WEB-INF/lib" includes="*.jar"/>
      <pathelement location="${forrest.home}/WEB-INF/classes"/>
      <fileset dir="${forrest.home}/WEB-INF/lib" includes="*.jar" />
      <pathelement location="${tools.jar}"/>
    </path>
  </target>


  <!-- ===============================================================
       Display the usage of this script. 
       =============================================================== -->
  <target name="usage" depends="init">
    <echo><![CDATA[
    Usage: This ant file holds the targets for letting the forrest 
    project work for your project.

    It is recommended that you have a FORREST_HOME environment variable
    that points to where this ant script (and the required directories) 
    is located.

    You can call these from your project ant file like this:
    <property environment="ENV" />

    <ant antfile="($forrest.home)/forrest.build.xml" 
         target="(your-target-of-choice)" >
      <property name="project.home" value="."/>
      <property name="forrest.home" value="${ENV.FORREST_HOME}"/>
    </ant>
    
    Relative to project.home there will be a number of default
    paths forrest will use to do the requested work.
    To see these (and their use), use the nested property:
      <property name="forrest.echo" value="true" />

    To override these you could do one of:
    - write them down in a file ${project.home}/forrest.properties
      (using Java Property file syntax)
    - set them as nested properties to the <ant> task.
    - set them from the command-line, eg -Dforrest.echo=true

    Targets to call:
    [site building targets]
    site ----------  Build your static project site.
    webapp --------  Bundle your documents in a dynamic cocoon-based webapp to deploy.
    `
    [project seeding targets]

    
    TODO... COMPLETE THIS:
    ]]></echo>
  </target>


<!-- ***************************************************************** -->
<!-- ***************************************************************** -->
<!-- **                                                             ** -->
<!-- **                                                             ** -->
<!-- **                  SITE BUILDING ACTIONS                      ** -->
<!-- **                                                             ** -->
<!-- **                                                             ** -->
<!-- ***************************************************************** -->
<!-- ***************************************************************** -->


  <!-- ===============================================================
       Fills the Cocoon context dir to work in 
       with the forrest-predefines.
       param: name of the skin to use ${project.skin} (now)
       param: location to make temporary context-dir ${project.ctxt-dir} 
       =============================================================== -->
  <target name="bare-context" depends="init" >
    <filter token="skin"              value="${project.skin}" />

    <!--
    These filters defined for backwards-compatibility with old skins.
    New skins should use the skinconfig.* filters, or actively parse the
    skinconf.xml file themselves. (JT)
    -->
    <filter token="link1"      value="${skinconfig.trail.link1.name}"/>
    <filter token="link1.href" value="${skinconfig.trail.link1.href}"/>
    <filter token="link2"      value="${skinconfig.trail.link2.name}"/>
    <filter token="link2.href" value="${skinconfig.trail.link2.href}"/>
    <filter token="link3"      value="${skinconfig.trail.link3.name}"/>
    <filter token="link3.href" value="${skinconfig.trail.link3.href}"/>
    <filter token="year"       value="${skinconfig.year}"/>
    <filter token="vendor"     value="${skinconfig.vendor}"/>
    <filter token="group-logo.src"  value="${skinconfig.group-logo}"/>
    <filter token="group-logo.href" value="${skinconfig.group-url}"/>
    <filter token="group-logo.alt"  value="${skinconfig.group-name} logo"/>
    <filter token="project-logo.src"  value="${skinconfig.project-logo}"/>
    <filter token="project-logo.href" value="${skinconfig.project-url}"/>
    <filter token="project-logo.alt"  value="${skinconfig.project-name} logo"/>

    <!-- NOW: filter-copy the empty-forrest-context -->
    <!-- WITH SitePlan: smaller empty-context, 1 unfiltered copy
                        + generate more stuff from siteplan -->

    <copy toDir="${project.ctxt-dir}/" filtering="off">
      <fileset dir="${forrest.home}/context" >
        <exclude name="sitemap.xmap" />
        <exclude name="skins/**" />
      </fileset>
      <fileset dir="${forrest.home}/context" >
        <include name="skins/**/images/**" />
      </fileset>
    </copy>

    <copy toDir="${project.ctxt-dir}/" filtering="on">
    <!-- everything in the skins, except the images , and the sitemap -->
      <fileset dir="${forrest.home}/context" >
        <include name="sitemap.xmap" />
        <include name="skins/**" />
        <exclude name="skins/**/images/**" />
      </fileset>
    </copy>
    <!--Hack to stop the classpath definition breaking. If the project has any
    custom jars or classes, they will be added to these dirs -->
    <mkdir dir="${project.ctxt-dir}/WEB-INF/lib"/>
    <mkdir dir="${project.ctxt-dir}/WEB-INF/classes"/>
  </target>


  <!-- ===============================================================
       Fills the Cocoon context dir to work in 
       with the project-content-parts 
         (now: copy stuff from param ${project.content-dir}
          with siteplan: based on that plan; should allow more different parts)
       param: location to find the content ${project.content-dir}(now)
       param: location of siteplan ${project.siteplan} (future)
       param: location to find project descriptors == ${project.home} 
       param: location to make temporary context-dir ${project.ctxt-dir} 
       =============================================================== -->
  <target name="project-context" depends="init, bare-context, examine-proj, copy-sitemap,
    copy-xdocs, copy-stylesheets, copy-images, copy-schema, copy-lib,
    copy-classes, copy-skins, copy-skinconf, copy-status"/>

  <target name="examine-proj">
    <available property="sitemap.present" file="${project.sitemap}"/>
    <available property="xdocs.present" file="${project.xdocs-dir}" type="dir"/>
    <available property="images.present" file="${project.images-dir}" type="dir"/>
    <available property="schema.present" file="${project.schema-dir}" type="dir"/>
    <available property="stylesheets.present" file="${project.stylesheets-dir}" type="dir"/>
    <available property="lib.present" file="${project.lib-dir}" type="dir"/>
    <available property="classes.present" file="${project.classes-dir}" type="dir"/>
    <available property="skins.present" file="${project.skins-dir}" type="dir"/>
    <available property="skinconf.present" file="${project.skinconf}"/>
    <available property="status.present" file="${project.status}"/>
  </target>

  <target name="copy-sitemap" if="sitemap.present">
    <copy file="${project.sitemap}" toDir="${project.ctxt-dir}" filtering="true"
      overwrite="true" failonerror="false"/>
  </target>

  <target name="copy-xdocs" if="xdocs.present">
    <copy toDir="${project.ctxt-dir}/content/xdocs" filtering="false"
      overwrite="true">
      <fileset dir="${project.xdocs-dir}"/>
    </copy>
  </target>

  <target name="copy-stylesheets" if="stylesheets.present">
    <copy toDir="${project.ctxt-dir}/resources/stylesheets" filtering="false"
      overwrite="true" failonerror="false">
      <fileset dir="${project.stylesheets-dir}"/>
    </copy>
  </target>

  <target name="copy-images" if="images.present">
    <copy toDir="${project.ctxt-dir}/resources/images" filtering="false"
      overwrite="true" failonerror="false">
      <fileset dir="${project.images-dir}"/>
    </copy>
  </target>

  <target name="copy-schema" if="schema.present">
    <echo>Copying schemas..</echo>
    <copy toDir="${project.ctxt-dir}/resources/schema" filtering="false"
      overwrite="true" failonerror="false">
      <fileset dir="${project.schema-dir}"/>
    </copy>
  </target>

  <target name="copy-lib" if="lib.present">
    <copy toDir="${project.ctxt-dir}/WEB-INF/lib" filtering="false"
      overwrite="true" failonerror="false">
      <fileset dir="${project.lib-dir}"/>
    </copy>
  </target>

  <target name="copy-classes" if="classes.present">
    <copy toDir="${project.ctxt-dir}/WEB-INF/classes" filtering="false"
      overwrite="true" failonerror="false">
      <fileset dir="${project.classes-dir}"/>
    </copy>
  </target>

  <target name="copy-skins" if="skins.present">
    <copy toDir="${project.ctxt-dir}/skins" filtering="true" overwrite="true" failonerror="false">
      <fileset dir="${project.skins-dir}"/>
    </copy>
  </target>

  <target name="copy-skinconf" if="skinconf.present">
    <copy file="${project.skinconf}"
      toDir="${project.ctxt-dir}" filtering="false"
      overwrite="true" failonerror="false"/>
  </target>

  <target name="copy-status" if="status.present">
    <copy file="${project.status}" todir="${project.ctxt-dir}" filtering="false"/>
  </target>


  <!-- ===============================================================
       Makes the Cocoon context dir to work in and fills it completely.
       That is by depending on:
         bare-context     // for forrest predefines.  
         project-context  // for project's actual content
           (now: copy stuff from extra param defining the content dir
            with siteplan: based on that)
         control-context  // for derivatives from siteplan 
           (now: no need, waiting on siteplan future)
            with siteplan: e.g. sitemap and catalog)
       param: name of the skin to use ${project.skin} (now)
       param: location to find the content ${project.content-dir}(now)
       param: location of siteplan ${project.siteplan} (future)
       param: location to make temporary context-dir ${project.ctxt-dir} 
       =============================================================== -->
  <target name="prepare-context" depends="init, bare-context, project-context" />


  <!-- ===============================================================
       Cleans the site.  (typically before generating the new version)
       param: location to clean ${project.site-dir}
       =============================================================== -->
  <target name="clean-site">
    <delete dir="${project.site-dir}"/>
  </target>


  <!-- ===============================================================
       Makes the site.
       param: name of the skin to use ${project.skin} (now)
       param: location to find the content ${project.content-dir}(now)
       param: location of siteplan ${project.siteplan} (future)
       param: location to make temporary context-dir ${project.ctxt-dir} 
       param: location to make temporary work-dir ${project.content-dir}
       param: debuglevel for logging ${project.debuglevel}
       param: location of log-file ${project.logfile}
       =============================================================== -->
  <target name="site" depends="init, prepare-context, clean-site, prepare-classpath">
    <!-- clean out the temp space, if we don't cocoon fails on this
         actually clears the cache, not yet clear why it is really needed? -->
    <delete dir="${project.work-dir}"/>
    <mkdir dir="${project.work-dir}"/>
    <java classname="org.apache.cocoon.Main" fork="true"
          dir="." failonerror="true"
          classpathref="forrest.cp"
          >
      <arg value="-c${project.ctxt-dir}"/>   <!-- input to the process -->
      <arg value="-d${project.site-dir}"/>   <!-- output to be put -->
      <arg value="-w${project.work-dir}"/>   <!-- temp dir to use for e.g. cache -->
      <arg value="-l${project.logfile}"/>    <!-- log of processing -->
      <arg value="-u${project.debuglevel}"/> <!-- threshold for log messages -->
      <arg value="-C${project.configfile}"/>      <!-- cocoon.xconf file to use -->
      <arg value="-b${project.brokenlinkfile}"/>  <!-- output list of broken links -->
      <arg value="${project.start-uri}"/>              <!-- starting page -->
      <arg value="-V" />                          <!-- be verbose -->
    </java>
    <echo>
Generation just finished. Please check the file ${project.brokenlinkfile} for any broken links in the generated site.
    </echo>
  </target>


  <target name="project.webapp.defined" unless="project.webapp">
    <echo>
      ------------------------------------------------
      Error: $${project.webapp} variable has not been set. This is where the
      webapp will be assembled. Please define it in the calling script.
      ------------------------------------------------
    </echo>
    <fail message="project.webapp variable not set"/>
  </target>

  <!-- ===============================================================
       Builds a cocoon webapp for your project based on the siteplan.
       param: location to put generated webapp ${project.webapp}
       =============================================================== -->
  <target name="webapp" depends="init, project.webapp.defined, prepare-context">
    <!-- this will need revisions in the case of the siteplan
    extra project-custom classes then will need to be warred in as well. -->
    <mkdir dir="${project.webapp}/WEB-INF"/>
    <copy file="${forrest.home}/WEB-INF/web.xml" todir="${project.webapp}/WEB-INF"/>
    <copy todir="${project.webapp}">
      <fileset dir="${project.ctxt-dir}" >
        <exclude name="*.xconf" /> <!-- CLI wants them there, webapp finds them in WEB-INF -->
      </fileset>
    </copy>
    <copy todir="${project.webapp}/WEB-INF">
      <fileset dir="${forrest.home}/WEB-INF">
        <include name="*.xconf" />
        <include name="lib/**"/>
        <include name="classes/**"/>
      </fileset>
    </copy>
  </target>

  <!-- ===============================================================
       Builds a cocoon webapp for your project based on the siteplan.
       param: location of siteplan ${project.siteplan}
       param: location to put generated war ${project.war}
       =============================================================== -->
  <target name="war" depends="init, prepare-context">
    <!-- this will need revisions in the case of the siteplan
         extra project-custom classes then will need to be warred in as well. -->
    <war warfile="${project.war}"
         webxml="${forrest.home}/WEB-INF/web.xml"
         compress="true">
      <fileset dir="${project.ctxt-dir}" >
        <exclude name="*.xconf" /> <!-- CLI wants them there, webapp finds them in WEB-INF -->
      </fileset>
      <webinf  dir="${forrest.home}/WEB-INF" >
        <include name="*.xconf" />
      </webinf>
      <lib     dir="${forrest.home}/WEB-INF/lib"     />
      <classes dir="${forrest.home}/WEB-INF/classes/"/>
    </war>
  </target>


  <!-- ===============================================================
       Validates all XML documents in the projects-context dir.
       param: location of siteplan ${forrest.siteplan} (future)

       TODO: based on the siteplan we could produce also the special 
       inline catalog format this task is needing. (in combination with 
       the new <import> of ant that could be really snap)
       =============================================================== -->
  <target name="validate" depends="init, prepare-context, prepare-classpath">
    <xmlvalidate failonerror="yes" lenient="yes" warn="yes"
       className="org.apache.xerces.parsers.SAXParser"
       classpathref="forrest.cp">
       <fileset dir="${project.ctxt-dir}">
         <include name="content/xdocs/*.xml"/>
         <include name="*.x*" />
         <exclude name="*build.xml"/>
       </fileset>
    </xmlvalidate>
  </target>


<!-- ***************************************************************** -->
<!-- ***************************************************************** -->
<!-- **                                                             ** -->
<!-- **                                                             ** -->
<!-- **          PROJECT-TEMPLATE BUILDING ACTIONS                  ** -->
<!-- **                                                             ** -->
<!-- **                                                             ** -->
<!-- ***************************************************************** -->
<!-- ***************************************************************** -->



  <!-- ===============================================================
        Copies a template structure over to your project dir.

        flag: with or without room for own skin 
        ... flags for others... thers

        Mind this is typically called before any forrest.properties
        or siteplan.xml exists (we should consider generating those as well
 
        maybe even a template ant build?

        dependend task for doing that alone.
        >>> filling this with stuff from smart acorn.xml idea.
       =============================================================== -->
  <target name="seed">
    <unzip src="${forrest.home}/fresh-site.zip" 
           dest="${project.home}"
           overwrite="false"                       />
  </target>



<!-- ***************************************************************** -->
<!-- ***************************************************************** -->
<!-- **                                                             ** -->
<!-- **                                                             ** -->
<!-- **                 BOT EXECUTING ACTIONS                       ** -->
<!-- **                                                             ** -->
<!-- **                                                             ** -->
<!-- ***************************************************************** -->
<!-- ***************************************************************** -->


<!-- currently just a cut and paste: none of this will work atm. -->
<!-- TODO... COMPLETE THIS: -->


  <!-- TODO: nuke this target after handling what it did elsewhere -->
  <target name="bot.init" depends="init">
    <!-- TODO: moce this to main init, should cone from project.home/forrest.properties -->
    <property name="bot.build.dir"              value="${xlayout.build.bot.dir}"/>
    <property name="bot.forrestbot.xconf"       value="forrestbot.conf.xml" />

    <!-- TODO: needs to be in the distribution -->
    <property name="bot.templates.build.xml" 
             value="${xlayout.source.resources.forrestbot.ant.dir}/templates.build.xml" />
    <property name="bot.work.builder.xslt"      
             value="${xlayout.source.resources.forrestbot.xslt.dir}/config2work.xsl" />
    <property name="bot.default.builder.xslt"   
             value="${xlayout.source.resources.forrestbot.xslt.dir}/config2defaults.xsl" />
  </target>


  <target name="bot.conf2build" depends="bot.init" >
    <mkdir dir="${bot.build.dir}" />
    <echo message="Using config file: ${bot.forrestbot.xconf}" />

    <property name="bot.work.build.xml"         value="${bot.build.dir}/work.build.xml"/>
    <property name="bot.default.parameters.xml" value="${bot.build.dir}/default.parameters.xml"/>

    <!-- remove previous versions to force generation again -->
    <delete file="${bot.work.build.xml}" />
    <delete file="${bot.default.parameters.xml}" />

    <!-- builds the different xml files this process needs.  -->
    <style in="${bot.forrestbot.xconf}"
      out="${bot.work.build.xml}"
      style="${bot.work.builder.xslt}"/>
    <style in="${bot.forrestbot.xconf}"
      out="${bot.default.parameters.xml}"
      style="${bot.default.builder.xslt}"/>
    <copy todir="${bot.build.dir}" file="${bot.templates.build.xml}"/>
  </target>


  <target name="bot" depends="bot.conf2build, prepare-classpath" >
    <!-- delegates to the generated XML file -->
    <ant antfile="${bot.work.build.xml}" target="work" inheritRefs="true"/>
  </target>


</project>
